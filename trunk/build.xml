<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Run" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" />
	
	<PropertyGroup>
		<Configuration Condition="'$(Configuration)'==''">Release</Configuration>
		<Version>1.0.0</Version>
		<Revision>0</Revision>
		<Build>0</Build>
		<SubversionDirectory>C:\Program Files (x86)\CollabNet Subversion Client</SubversionDirectory>
	</PropertyGroup>
	
	<PropertyGroup>
		<xUnitDirectory>$(MSBuildProjectDirectory)\lib\trove\Framework\v2.0</xUnitDirectory>
	</PropertyGroup>
	<UsingTask TaskName="Xunit.Runner.MSBuild.xunit" AssemblyFile="$(xUnitDirectory)\xunit.runner.msbuild.dll" />
	<UsingTask TaskName="Xunit.Runner.MSBuild.CombineXunitXml" AssemblyFile="$(xUnitDirectory)\xunit.runner.msbuild.dll" />
	
	<Target Name="Run">
		<CallTarget Targets="Clean" />
		<CallTarget Targets="Build" />
		<CallTarget Targets="Test" />
		<CallTarget Targets="Zip" />
	</Target>
	
	<Target Name="Clean">
		<MSBuild
			Projects="$(MSBuildProjectDirectory)\src\Cavity.sln"
			Targets="Clean"
			Properties="Configuration=$(Configuration)"
			/>
	</Target>
	
	<Target Name="Versioning">
		<SvnVersion LocalPath=".">
			<Output TaskParameter="Revision" PropertyName="Revision" />
		</SvnVersion>
		<Math.Add Numbers="$(Revision);1">
			<Output TaskParameter="Result" PropertyName="Build" />
		</Math.Add>
		<AssemblyInfo
			CodeLanguage="CS"
			OutputFile="$(MSBuildProjectDirectory)\src\Build.cs"
			AssemblyVersion="$(Version).$(Build)"
			AssemblyFileVersion="$(Version).$(Build)"
			AssemblyInformationalVersion="$(Version).$(Build)"
			/>
	</Target>
	
	<Target Name="Build" DependsOnTargets="Versioning">
		<MSBuild
			Projects="$(MSBuildProjectDirectory)\src\Cavity.sln"
			Targets="Rebuild"
			Properties="Configuration=$(Configuration)">
			<Output
				TaskParameter="TargetOutputs"
				ItemName="CodeAssemblies"
				/>
		</MSBuild>
	</Target>
	
	<PropertyGroup>
		<TestResultsDirectory>$(MSBuildProjectDirectory)\TestResults</TestResultsDirectory>
		<ClassLibrariesPath>$(MSBuildProjectDirectory)\src\ClassLibraries</ClassLibrariesPath>
		<ConsoleApplicationsPath>$(MSBuildProjectDirectory)\src\ConsoleApplications</ConsoleApplicationsPath>
	</PropertyGroup>
	
	<Target Name="Test">
		<RemoveDir
			Directories="$(TestResultsDirectory)"
			Condition="Exists('$(TestResultsDirectory)')"
			/>
		<MakeDir
			Directories="$(TestResultsDirectory)"
			Condition="!Exists('$(TestResultsDirectory)')"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\Core.Facts\bin\$(Configuration)\Cavity.Core.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\Core.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\core_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\Http.Client.Facts\bin\$(Configuration)\Cavity.Http.Client.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\Http.Client.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\http_client_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\ServiceLocation.Facts\bin\$(Configuration)\Cavity.ServiceLocation.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\ServiceLocation.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\service_location_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\ServiceLocation.Autofac.Facts\bin\$(Configuration)\Cavity.ServiceLocation.Autofac.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\ServiceLocation.Autofac.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\service_location_autofac_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\ServiceLocation.CastleWindsor.Facts\bin\$(Configuration)\Cavity.ServiceLocation.CastleWindsor.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\ServiceLocation.CastleWindsor.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\service_location_castle_windsor_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\ServiceLocation.StructureMap.Facts\bin\$(Configuration)\Cavity.ServiceLocation.StructureMap.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\ServiceLocation.StructureMap.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\service_location_structuremap_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\ServiceLocation.Unity.Facts\bin\$(Configuration)\Cavity.ServiceLocation.Unity.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\ServiceLocation.Unity.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\service_location_unity_facts_xunit.xml"
			/>
		<xunit
			ContinueOnError="false"
			Assembly="$(ClassLibrariesPath)\Testing.Unit.Facts\bin\$(Configuration)\Cavity.Testing.Unit.Facts.dll"
			WorkingFolder="$(ClassLibrariesPath)\Testing.Unit.Facts\bin\$(Configuration)"
			Xml="$(TestResultsDirectory)\testing_unit_facts_xunit.xml"
			/>
		<Exec
			Command="Example.Autofac.Console.exe"
			WorkingDirectory="$(ConsoleApplicationsPath)\Example.Autofac.Console\bin\$(Configuration)"
			/>
		<Exec
			Command="Example.CastleWindsor.Console.exe"
			WorkingDirectory="$(ConsoleApplicationsPath)\Example.CastleWindsor.Console\bin\$(Configuration)"
			/>
		<Exec
			Command="Example.StructureMap.Console.exe"
			WorkingDirectory="$(ConsoleApplicationsPath)\Example.StructureMap.Console\bin\$(Configuration)"
			/>
		<Exec
			Command="Example.Unity.Console.exe"
			WorkingDirectory="$(ConsoleApplicationsPath)\Example.Unity.Console\bin\$(Configuration)"
			/>
		<!-- merging test files -->
		<CreateItem Include="$(TestResultsDirectory)\*_xunit.xml">
			<Output TaskParameter="Include" ItemName="XmlTestFiles" />
		</CreateItem>
		<CombineXunitXml
			InputFiles="@(XmlTestFiles)"
			OutputFile="$(TestResultsDirectory)\Combined.xml"
			/>
		<Delete Files="@(XmlTestFiles)" />
		<!-- deleting the combined xml file as it isn't being used -->
		<RemoveDir
			Directories="$(TestResultsDirectory)"
			Condition="Exists('$(TestResultsDirectory)')"
			/>
	</Target>
	
	<PropertyGroup>
		<ZipDirectory>$(MSBuildProjectDirectory)\zip</ZipDirectory>
		<PublishDirectory>$(MSBuildProjectDirectory)\Publish</PublishDirectory>
	</PropertyGroup>
	
	<Target Name="Zip">
		<CallTarget Targets="Create Zip Folder" />
		<CallTarget Targets="Zip Source" />
		<CallTarget Targets="Zip HTTP Client" />
		<CallTarget Targets="Zip Unit Testing" />
		<CallTarget Targets="Zip Autofac Package" />
		<CallTarget Targets="Zip Castle Windsor Package" />
		<CallTarget Targets="Zip StructureMap Package" />
		<CallTarget Targets="Zip Unity Package" />
		<CallTarget Targets="Delete Publish Folder" />
	</Target>
	
	<Target Name="Create Zip Folder">
		<RemoveDir
			Directories="$(ZipDirectory)"
			Condition="Exists('$(ZipDirectory)')"
			/>
		<MakeDir
			Directories="$(ZipDirectory)"
			Condition="!Exists('$(ZipDirectory)')"
			/>
	</Target>
	
	<Target Name="Zip Source">
		<MakeDir
			Directories="$(PublishDirectory)\Source"
			Condition="!Exists('$(PublishDirectory)\Source')"
			/>
		<RoboCopy
			SourceFolder="$(MSBuildProjectDirectory)\src"
			DestinationFolder="$(PublishDirectory)\Source"
			Mirror="true"
			ExcludeFolders=".svn;_svn;obj;bin;PrecompiledWeb"
			ExcludeFiles="*.suo;*.csproj.user;*.vs10x;StyleCop.Cache"
			NoJobHeader="true"
			/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Source [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipSourceFiles Include="$(PublishDirectory)\Source\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipSourceFiles)"
			WorkingDirectory="$(PublishDirectory)\Source"
			ZipFileName="$(ZipDirectory)\Cavity Source [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\Source"
			Condition="Exists('$(PublishDirectory)\Source')"
			/>
	</Target>
	
	<Target Name="Zip HTTP Client">
		<RemoveDir
			Directories="$(PublishDirectory)\Http.Client"
			Condition="Exists('$(PublishDirectory)\Http.Client')"
			/>
		<MakeDir
			Directories="$(PublishDirectory)\Http.Client"
			Condition="!Exists('$(PublishDirectory)\Http.Client')"
			/>
		<RoboCopy
			SourceFolder="$(ClassLibrariesPath)\Http.Client\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\Http.Client"
			Mirror="true"
			ExcludeFolders=".svn;_svn;obj"
			ExcludeFiles="*.pdb;*.xml;*.stylecop;*CodeAnalysis*"
			NoJobHeader="true"
			/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity HTTP Client [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipHttpClientFiles Include="$(PublishDirectory)\Http.Client\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipHttpClientFiles)"
			WorkingDirectory="$(PublishDirectory)\Http.Client"
			ZipFileName="$(ZipDirectory)\Cavity HTTP Client [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\Http.Client"
			Condition="Exists('$(PublishDirectory)\Http.Client')"
			/>
	</Target>
	
	<Target Name="Zip Unit Testing">
		<RemoveDir
			Directories="$(PublishDirectory)\Testing.Unit"
			Condition="Exists('$(PublishDirectory)\Testing.Unit')"
			/>
		<MakeDir
			Directories="$(PublishDirectory)\Testing.Unit"
			Condition="!Exists('$(PublishDirectory)\UnitTesting')"
			/>
		<RoboCopy
			SourceFolder="$(ClassLibrariesPath)\Testing.Unit\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\UnitTesting"
			Mirror="true"
			ExcludeFolders=".svn;_svn;obj"
			ExcludeFiles="*.pdb;*.xml;*.stylecop;*CodeAnalysis*"
			NoJobHeader="true"
			/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Unit Testing [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipUnitTestingFiles Include="$(PublishDirectory)\Testing.Unit\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipUnitTestingFiles)"
			WorkingDirectory="$(PublishDirectory)\Testing.Unit"
			ZipFileName="$(ZipDirectory)\Cavity Unit Testing [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\Testing.Unit"
			Condition="Exists('$(PublishDirectory)\Testing.Unit')"
			/>
	</Target>
	
	<Target Name="Zip Autofac Package">
		<MakeDir
			Directories="$(PublishDirectory)\Autofac"
			Condition="!Exists('$(PublishDirectory)\Autofac')"
			/>
		<RoboCopy
			SourceFolder="$(ConsoleApplicationsPath)\Example.Autofac.Console\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\Autofac"
			Mirror="true"
			ExcludeFolders=""
			ExcludeFiles="*.pdb;*.exe;*.xml;*.lastcodeanalysissucceeded;Example.dll"
			NoJobHeader="true"
			/>
		<Exec
			Command="RENAME Example.Autofac.Console.exe.config app.config"
			WorkingDirectory="$(PublishDirectory)\Autofac"
			/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Autofac\app.config"
			XPath="/configuration/startup"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Autofac\autofac.config"
			XPath="/autofac/@defaultAssembly"
			Value=""/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Autofac\autofac.config"
			XPath="/autofac/components/component"
			Delete="true"/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Service Location (Autofac) [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipAutofacFiles Include="$(PublishDirectory)\Autofac\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipAutofacFiles)"
			WorkingDirectory="$(PublishDirectory)\Autofac"
			ZipFileName="$(ZipDirectory)\Cavity Service Location (Autofac) [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\Autofac"
			Condition="Exists('$(PublishDirectory)\Autofac')"
			/>
	</Target>

	<Target Name="Zip Castle Windsor Package">
		<MakeDir
			Directories="$(PublishDirectory)\CastleWindsor"
			Condition="!Exists('$(PublishDirectory)\CastleWindsor')"
			/>
		<RoboCopy
			SourceFolder="$(ConsoleApplicationsPath)\Example.CastleWindsor.Console\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\CastleWindsor"
			Mirror="true"
			ExcludeFolders=""
			ExcludeFiles="*.pdb;*.exe;*.xml;*.lastcodeanalysissucceeded;Example.dll"
			NoJobHeader="true"
			/>
		<Exec
			Command="RENAME Example.CastleWindsor.Console.exe.config app.config"
			WorkingDirectory="$(PublishDirectory)\CastleWindsor"
			/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\CastleWindsor\app.config"
			XPath="/configuration/startup"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\CastleWindsor\castle.config"
			XPath="/castle/components/component"
			Delete="true"/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Service Location (Castle Windsor) [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipCastleWindsorFiles Include="$(PublishDirectory)\CastleWindsor\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipCastleWindsorFiles)"
			WorkingDirectory="$(PublishDirectory)\CastleWindsor"
			ZipFileName="$(ZipDirectory)\Cavity Service Location (Castle Windsor) [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\CastleWindsor"
			Condition="Exists('$(PublishDirectory)\CastleWindsor')"
			/>
	</Target>

	<Target Name="Zip StructureMap Package">
		<MakeDir
			Directories="$(PublishDirectory)\StructureMap"
			Condition="!Exists('$(PublishDirectory)\StructureMap')"
			/>
		<RoboCopy
			SourceFolder="$(ConsoleApplicationsPath)\Example.StructureMap.Console\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\StructureMap"
			Mirror="true"
			ExcludeFolders=""
			ExcludeFiles="*.pdb;*.exe;*.xml;*.lastcodeanalysissucceeded;Example.dll"
			NoJobHeader="true"
			/>
		<Exec
			Command="RENAME Example.StructureMap.Console.exe.config app.config"
			WorkingDirectory="$(PublishDirectory)\StructureMap"
			/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\StructureMap\app.config"
			XPath="/configuration/startup"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\StructureMap\StructureMap.config"
			XPath="/StructureMap/DefaultInstance"
			Delete="true"/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Service Location (StructureMap) [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipStructureMapFiles Include="$(PublishDirectory)\StructureMap\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipStructureMapFiles)"
			WorkingDirectory="$(PublishDirectory)\StructureMap"
			ZipFileName="$(ZipDirectory)\Cavity Service Location (StructureMap) [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\StructureMap"
			Condition="Exists('$(PublishDirectory)\StructureMap')"
			/>
	</Target>

	<Target Name="Zip Unity Package">
		<MakeDir
			Directories="$(PublishDirectory)\Unity"
			Condition="!Exists('$(PublishDirectory)\Unity')"
			/>
		<RoboCopy
			SourceFolder="$(ConsoleApplicationsPath)\Example.Unity.Console\bin\$(Configuration)"
			DestinationFolder="$(PublishDirectory)\Unity"
			Mirror="true"
			ExcludeFolders=""
			ExcludeFiles="*.pdb;*.exe;*.xml;*.lastcodeanalysissucceeded;Example.dll"
			NoJobHeader="true"
			/>
		<Exec
			Command="RENAME Example.Unity.Console.exe.config app.config"
			WorkingDirectory="$(PublishDirectory)\Unity"
			/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Unity\app.config"
			XPath="/configuration/startup"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Unity\unity.config"
			XPath="/unity/typeAliases/typeAlias[@alias='ITest']"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Unity\unity.config"
			XPath="/unity/typeAliases/typeAlias[@alias='Tester']"
			Delete="true"/>
		<XmlUpdate
			XmlFileName="$(PublishDirectory)\Unity\unity.config"
			XPath="/unity/containers/container"
			Delete="true"/>
		<Exec
			Command="DEL /Q /F &quot;$(ZipDirectory)\Cavity Service Location (Unity) [$(Configuration) $(Version).$(Build)].zip&quot;"
			WorkingDirectory="$(ZipDirectory)"
			/>
		<ItemGroup>
			<ZipUnityFiles Include="$(PublishDirectory)\Unity\**\*.*" />
		</ItemGroup>
		<Zip
			Files="@(ZipUnityFiles)"
			WorkingDirectory="$(PublishDirectory)\Unity"
			ZipFileName="$(ZipDirectory)\Cavity Service Location (Unity) [$(Configuration) $(Version).$(Build)].zip"
			ZipLevel="9"
			/>
		<RemoveDir
			Directories="$(PublishDirectory)\Unity"
			Condition="Exists('$(PublishDirectory)\Unity')"
			/>
	</Target>

	<Target Name="Delete Publish Folder">
		<RemoveDir
			Directories="$(PublishDirectory)"
			Condition="Exists('$(PublishDirectory)')"
			/>
	</Target>
	
</Project>