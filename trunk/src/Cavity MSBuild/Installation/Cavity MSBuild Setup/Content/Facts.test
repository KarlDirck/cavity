<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(MSBuildExtensionsPath)\xunit\xunit.runner.msbuild.dll" TaskName="Xunit.Runner.MSBuild.CombineXunitXml" />
  <UsingTask AssemblyFile="$(MSBuildExtensionsPath)\xunit\xunit.runner.msbuild.dll" TaskName="Xunit.Runner.MSBuild.xunit" />
  <UsingTask AssemblyFile="$(MSBuildExtensionsPath)\xunit\xunit.runner.msbuild.dll" TaskName="Xunit.Runner.MSBuild.xunitproject" />
  <PropertyGroup>
    <XunitTestResultsDirectory>$(MSBuildProjectDirectory)\xunit-test-results</XunitTestResultsDirectory>
  </PropertyGroup>
  <Target Name="Test Facts">
    <RemoveDir Directories="$(XunitTestResultsDirectory)"
               Condition="Exists('$(XunitTestResultsDirectory)')" />
    <MakeDir Directories="$(XunitTestResultsDirectory)"
             Condition="!Exists('$(XunitTestResultsDirectory)')" />
    <CallTarget Targets="Test obj removal" />
    <CallTarget Targets="Test xunit" />
    <CallTarget Targets="Test xunit merge" />
    <RemoveDir Directories="$(XunitTestResultsDirectory)"
               Condition="Exists('$(XunitTestResultsDirectory)')" />
  </Target>
  <Target Name="Test obj removal">
    <ItemGroup>
      <CsProjFiles Include="$(MSBuildProjectDirectory)\**\*.csproj" />
    </ItemGroup>
    <RemoveDir Directories="%(CsProjFiles.RelativeDir)obj\" />
  </Target>
  <Target Name="Test xunit"
          Condition=" '$(TargetFrameworkVersion)' != 'v2.0' ">
    <ItemGroup>
      <FactsFiles Include="$(MSBuildProjectDirectory)\**\*.Facts.dll" />
    </ItemGroup>
    <Xunit.Runner.MSBuild.xunit ContinueOnError="false"
                                Assembly="%(FactsFiles.FullPath)"
                                ShadowCopy="false"
                                Xml="$(XunitTestResultsDirectory)\%(FactsFiles.Filename).xunit" />
  </Target>
  <Target Name="Test xunit merge">
    <CreateItem Include="$(XunitTestResultsDirectory)\*.xunit">
      <Output TaskParameter="Include"
              ItemName="XunitTestFiles" />
    </CreateItem>
    <Xunit.Runner.MSBuild.CombineXunitXml InputFiles="@(XunitTestFiles)"
                                          OutputFile="$(XunitTestResultsDirectory)\Combined.xml" />
    <Delete Files="@(XunitTestFiles)" />
  </Target>
</Project>